<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†å›¾è°±ä¿®å¤éªŒè¯</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .graph-container {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 1rem;
            margin: 2rem 0;
            position: relative;
            min-height: 700px;
            overflow: hidden;
            border: 2px solid #374151;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success { background: #d4edda; color: #155724; }
        .info { background: #d1ecf1; color: #0c5460; }
        .controls {
            text-align: center;
            margin-bottom: 1rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            margin: 0 0.5rem;
            border: none;
            border-radius: 6px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            font-weight: 600;
        }
        .btn:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š çŸ¥è¯†å›¾è°±ä¿®å¤éªŒè¯</h1>

        <div class="status success">
            <h3>âœ… ä¿®å¤å®Œæˆ</h3>
            <p>çŸ¥è¯†å›¾è°±æ˜¾ç¤ºé—®é¢˜å·²ä¿®å¤ï¼Œç°åœ¨èŠ‚ç‚¹ä¼šæ­£ç¡®åˆ†æ•£åœ¨é¡µé¢ä¸­å¤®</p>
        </div>

        <div class="status info">
            <h3>ğŸ¯ ä¿®å¤å†…å®¹</h3>
            <ul>
                <li>âœ… è§£å†³èŠ‚ç‚¹çº¿æ€§æ’åˆ—åœ¨å·¦ä¾§çš„é—®é¢˜</li>
                <li>âœ… å®ç°åŠ›å¯¼å‘å›¾æ­£ç¡®å¸ƒå±€</li>
                <li>âœ… æ·»åŠ ç¼©æ”¾åŠŸèƒ½ (0.3x - 3x)</li>
                <li>âœ… èŠ‚ç‚¹æ‹–æ‹½å’Œäº¤äº’</li>
                <li>âœ… é‡ç½®è§†å›¾æŒ‰é’®</li>
                <li>âœ… æ‚¬åœé«˜äº®æ•ˆæœ</li>
            </ul>
        </div>

        <div class="controls">
            <button class="btn" onclick="loadFullGraph()">å®Œæ•´æ¡†æ¶</button>
            <button class="btn" onclick="loadATSLP()">ATSLPç®—æ³•</button>
            <button class="btn" onclick="loadHCMPL()">HCMPLç®—æ³•</button>
            <button class="btn" onclick="loadCALK()">CALKç®—æ³•</button>
        </div>

        <div class="graph-container">
            <div id="loading" style="color: white; text-align: center;">
                <h3>ğŸ”„ æ­£åœ¨åŠ è½½çŸ¥è¯†å›¾è°±...</h3>
                <p>è¯·ç¨å€™ï¼Œå›¾è°±å°†åœ¨é¡µé¢ä¸­å¤®å±•å¼€</p>
            </div>
        </div>

        <div class="status info">
            <h3>ğŸ® ä½¿ç”¨æŒ‡å—</h3>
            <ul>
                <li><strong>ç¼©æ”¾</strong>ï¼šé¼ æ ‡æ»šè½®ç¼©æ”¾</li>
                <li><strong>æ‹–æ‹½</strong>ï¼šæ‹–åŠ¨ç”»å¸ƒç§»åŠ¨è§†å›¾</li>
                <li><strong>èŠ‚ç‚¹æ‹–æ‹½</strong>ï¼šæ‹–åŠ¨èŠ‚ç‚¹æ”¹å˜ä½ç½®</li>
                <li><strong>æ‚¬åœ</strong>ï¼šé¼ æ ‡æ‚¬åœæŸ¥çœ‹è¯¦æƒ…</li>
                <li><strong>é‡ç½®</strong>ï¼šç‚¹å‡»é‡ç½®è§†å›¾æŒ‰é’®</li>
            </ul>
        </div>
    </div>

    <script>
        let svg, width, height, simulation, tooltip;

        // æµ‹è¯•æ•°æ®
        const testData = {
            nodes: [
                {id: 'ATSLP', name: 'ATSLP', category: 'core', description: 'è‡ªé€‚åº”ä»»åŠ¡è°ƒåº¦ç®—æ³•'},
                {id: 'HCMPL', name: 'HCMPL', category: 'core', description: 'å±‚æ¬¡ç¼“å­˜ç®¡ç†ç®—æ³•'},
                {id: 'CALK', name: 'CALK', category: 'core', description: 'åä½œå­¦ä¹ ç®—æ³•'},
                {id: 'TaskDecomposition', name: 'ä»»åŠ¡åˆ†è§£', category: 'component', description: 'å°†å¤æ‚ä»»åŠ¡åˆ†è§£ä¸ºå­ä»»åŠ¡'},
                {id: 'LoadBalancer', name: 'è´Ÿè½½å‡è¡¡', category: 'component', description: 'åŠ¨æ€åˆ†é…è®¡ç®—èµ„æº'},
                {id: 'CacheManager', name: 'ç¼“å­˜ç®¡ç†', category: 'component', description: 'æ™ºèƒ½ç¼“å­˜ç­–ç•¥'},
                {id: 'WorkerAgent', name: 'å·¥ä½œæ™ºèƒ½ä½“', category: 'agent', description: 'æ‰§è¡Œå…·ä½“ä»»åŠ¡çš„æ™ºèƒ½ä½“'},
                {id: 'CoordinatorAgent', name: 'åè°ƒæ™ºèƒ½ä½“', category: 'agent', description: 'åè°ƒå¤šä¸ªæ™ºèƒ½ä½“'},
                {id: 'DSLParser', name: 'DSLè§£æå™¨', category: 'interface', description: 'è§£æé¢†åŸŸç‰¹å®šè¯­è¨€'},
                {id: 'APIGateway', name: 'APIç½‘å…³', category: 'interface', description: 'ç»Ÿä¸€æ¥å£ç®¡ç†'},
                {id: 'MetricsStore', name: 'æŒ‡æ ‡å­˜å‚¨', category: 'data', description: 'å­˜å‚¨æ€§èƒ½æŒ‡æ ‡'},
                {id: 'TaskQueue', name: 'ä»»åŠ¡é˜Ÿåˆ—', category: 'data', description: 'ä»»åŠ¡æ’é˜Ÿç®¡ç†'}
            ],
            links: [
                {source: 'ATSLP', target: 'TaskDecomposition'},
                {source: 'ATSLP', target: 'LoadBalancer'},
                {source: 'HCMPL', target: 'CacheManager'},
                {source: 'CALK', target: 'WorkerAgent'},
                {source: 'CALK', target: 'CoordinatorAgent'},
                {source: 'TaskDecomposition', target: 'WorkerAgent'},
                {source: 'LoadBalancer', target: 'CoordinatorAgent'},
                {source: 'WorkerAgent', target: 'DSLParser'},
                {source: 'CoordinatorAgent', target: 'APIGateway'},
                {source: 'CacheManager', target: 'MetricsStore'},
                {source: 'DSLParser', target: 'TaskQueue'},
                {source: 'APIGateway', target: 'MetricsStore'}
            ]
        };

        function initializeGraph() {
            const container = document.querySelector('.graph-container');
            width = container.clientWidth - 40;
            height = 700;

            // ç§»é™¤loading
            document.getElementById('loading').style.display = 'none';

            // æ¸…é™¤ç°æœ‰å†…å®¹
            d3.select('#knowledge-graph').remove();

            // åˆ›å»ºSVG
            svg = d3.select('.graph-container')
                .append('svg')
                .attr('id', 'knowledge-graph')
                .attr('width', width)
                .attr('height', height)
                .style('background', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)')
                .style('border-radius', '12px');

            // æ·»åŠ ç¼©æ”¾
            const zoom = d3.zoom()
                .scaleExtent([0.3, 3])
                .on('zoom', function(event) {
                    svg.select('.graph-container-g').attr('transform', event.transform);
                });

            svg.call(zoom);
            svg.append('g').attr('class', 'graph-container-g');

            // åˆ›å»ºtooltip
            tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0)
                .style('position', 'absolute')
                .style('background', 'rgba(0,0,0,0.8)')
                .style('color', 'white')
                .style('padding', '8px 12px')
                .style('border-radius', '6px')
                .style('font-size', '12px')
                .style('pointer-events', 'none')
                .style('z-index', '1000');

            renderGraph(testData);
        }

        function renderGraph(data) {
            const nodes = data.nodes.map(d => ({...d}));
            const links = data.links.map(d => ({...d}));

            // è®¾ç½®åˆå§‹ä½ç½®
            nodes.forEach((d, i) => {
                const angle = (i / nodes.length) * 2 * Math.PI;
                const radius = Math.min(width, height) * 0.15;
                d.x = width / 2 + radius * Math.cos(angle) + (Math.random() - 0.5) * 100;
                d.y = height / 2 + radius * Math.sin(angle) + (Math.random() - 0.5) * 100;
            });

            const colorMap = {
                'core': '#ffffff',
                'component': '#a7f3d0',
                'agent': '#fcd34d',
                'interface': '#c4b5fd',
                'data': '#fca5a5'
            };

            // åŠ›æ¨¡æ‹Ÿ
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(120).strength(0.8))
                .force("charge", d3.forceManyBody().strength(-600))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(30))
                .alpha(1)
                .alphaDecay(0.02);

            const g = svg.select('.graph-container-g');
            g.selectAll("*").remove();

            // è¿æ¥çº¿
            const link = g.append("g")
                .selectAll("line")
                .data(links)
                .enter().append("line")
                .style("stroke", "#ffffff")
                .style("stroke-opacity", 0.6)
                .style("stroke-width", 2);

            // èŠ‚ç‚¹
            const node = g.append("g")
                .selectAll("g")
                .data(nodes)
                .enter().append("g")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            node.append("circle")
                .attr("r", d => d.category === 'core' ? 25 : 18)
                .attr("fill", d => colorMap[d.category])
                .attr("stroke", "#fff")
                .attr("stroke-width", 2)
                .style("cursor", "pointer");

            node.append("text")
                .attr("dy", ".35em")
                .attr("text-anchor", "middle")
                .text(d => d.name.length > 6 ? d.name.substring(0, 4) + '..' : d.name)
                .style("font-size", "10px")
                .style("font-weight", "600")
                .style("fill", "#333")
                .style("pointer-events", "none");

            // æ‚¬åœæ•ˆæœ
            node.on("mouseover", function(event, d) {
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`<strong>${d.name}</strong><br/>${d.description}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function() {
                tooltip.transition().duration(500).style("opacity", 0);
            });

            // åŠ¨ç”»æ›´æ–°
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });

            // é‡ç½®æŒ‰é’®
            const resetButton = svg.append("g")
                .attr("transform", "translate(20, 20)")
                .style("cursor", "pointer")
                .on("click", function() {
                    svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
                });

            resetButton.append("rect")
                .attr("width", 80)
                .attr("height", 30)
                .attr("rx", 15)
                .attr("fill", "rgba(255,255,255,0.9)");

            resetButton.append("text")
                .attr("x", 40)
                .attr("y", 20)
                .attr("text-anchor", "middle")
                .style("font-size", "11px")
                .style("font-weight", "600")
                .text("é‡ç½®è§†å›¾");
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // æŒ‰é’®åŠŸèƒ½
        function loadFullGraph() { renderGraph(testData); }
        function loadATSLP() {
            const atslpData = {
                nodes: testData.nodes.filter(n => ['ATSLP', 'TaskDecomposition', 'LoadBalancer', 'WorkerAgent'].includes(n.id)),
                links: testData.links.filter(l => ['ATSLP', 'TaskDecomposition', 'LoadBalancer', 'WorkerAgent'].includes(l.source) ||
                                                   ['ATSLP', 'TaskDecomposition', 'LoadBalancer', 'WorkerAgent'].includes(l.target))
            };
            renderGraph(atslpData);
        }
        function loadHCMPL() {
            const hcmplData = {
                nodes: testData.nodes.filter(n => ['HCMPL', 'CacheManager', 'MetricsStore'].includes(n.id)),
                links: testData.links.filter(l => ['HCMPL', 'CacheManager', 'MetricsStore'].includes(l.source) ||
                                                   ['HCMPL', 'CacheManager', 'MetricsStore'].includes(l.target))
            };
            renderGraph(hcmplData);
        }
        function loadCALK() {
            const calkData = {
                nodes: testData.nodes.filter(n => ['CALK', 'WorkerAgent', 'CoordinatorAgent'].includes(n.id)),
                links: testData.links.filter(l => ['CALK', 'WorkerAgent', 'CoordinatorAgent'].includes(l.source) ||
                                                   ['CALK', 'WorkerAgent', 'CoordinatorAgent'].includes(l.target))
            };
            renderGraph(calkData);
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeGraph, 500);
        });
    </script>
</body>
</html>